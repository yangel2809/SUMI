{% extends "layouts/base.html" %}
{% block content %}
<!-- form_view.html -->
<link href="{{ ASSETS_ROOT }}/css/plan-form.css" rel="stylesheet" />
<style>
  /* Reducir el espacio arriba y abajo de los labels a la mitad */
  #main-form label.form-label {
    margin-top: 0.25rem !important;
    margin-bottom: 0.25rem !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    line-height: 1.2 !important;
  }
  /* Separar los títulos h5 de los labels siguientes */
  #main-form h5 {
    margin-bottom: 0.5rem !important;
  }
</style>
<div class="container-fluid pt-1 px-sm-4 px-3 pb-3">
  <div class="row min-vh-80 h-100">
    <div class="col-12 px-0 px-md-2">
      <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-2 mx-md-3 z-index-2" style="user-select: none">
          <div class="bg-primary shadow-primary border-radius-lg ps-3 pt-2 pb-2">
            <div class="mt-2 text-center">
              <h4 class="text-white text-center font-weight-bolder me-3">{% if 'edit' in request.get_full_path %}Editar {% else %}Nueva {% endif %}Solicitud de Arte</h4>
            </div>
          </div>
          <div class="card-body px-md-0 px-2 py-2">
            <div class="form-group d-flex input-group input-group-outline">
              <form class="form justify-content-center col-12" method="POST" style="user-select: none" id="main-form" novalidate>
                {% csrf_token %}
                <div class="row px-1 px-md-3">
                  <h5 class="text-bold text-primary text-center pt-1 m-0">Información General</h5>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.date.id_for_label }}" class="form-label" style="position: relative;">Fecha de Solicitud</label>
                    {{ form.date }}
                    {% for error in form.date.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.client.id_for_label }}" class="form-label" style="position: relative;">Cliente</label>
                    {{ form.client }}
                    {% for error in form.client.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.applicant.id_for_label }}" class="form-label" style="position: relative;">Solicitante</label>
                    {{ form.applicant }}
                    {% for error in form.applicant.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.company.id_for_label }}" class="form-label" style="position: relative;">Empresa Solicitante</label>
                    {{ form.company }}
                    {% for error in form.company.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <h5 class="text-bold text-primary text-center pt-3 m-0">Detalles del Producto y Trabajo</h5>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.product_name.id_for_label }}" class="form-label" style="position: relative;">Producto</label>
                    {{ form.product_name }}
                    {% for error in form.product_name.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.work_type.id_for_label }}" class="form-label" style="position: relative;">Tipo de Trabajo</label>
                    {{ form.work_type }}
                    {% for error in form.work_type.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.supplied_material.id_for_label }}" class="form-label" style="position: relative;">Material Suministrado</label>
                    {{ form.supplied_material }}
                    {% for error in form.supplied_material.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.other_supplied_material.id_for_label }}" class="form-label" style="position: relative;">Otro Material (si aplica)</label>
                    {{ form.other_supplied_material }}
                    {% for error in form.other_supplied_material.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>

                  <h5 class="text-bold text-primary text-center pt-3 m-0">Especificaciones de Impresión</h5>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.printer.id_for_label }}" class="form-label" style="position: relative;">Impresora</label>
                    {{ form.printer }}
                    {% for error in form.printer.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.print_substrate.id_for_label }}" class="form-label" style="position: relative;">Sustrato a Imprimir</label>
                    {{ form.print_substrate }}
                    {% for error in form.print_substrate.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.print_type.id_for_label }}" class="form-label" style="position: relative;">Tipo de Impresión</label>
                    {{ form.print_type }}
                    {% for error in form.print_type.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-12 mb-3">
                    <label for="{{ form.product_structure.id_for_label }}" class="form-label" style="position: relative;">Estructura del Producto</label>
                    {{ form.product_structure }}
                    {% for error in form.product_structure.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>

                  <!---INLINE FORMSET-->
                  {% include 'essays/formsets/art_colors.html' %}
                  <!---->

                  <h5 class="text-bold text-primary text-center pt-3 m-0">Detalles de Logo</h5>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.company_logo.id_for_label }}" class="form-label" style="position: relative;">Logo Compañía</label>
                    {{ form.company_logo }}
                    {% for error in form.company_logo.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.logo_type.id_for_label }}" class="form-label" style="position: relative;">Tipo de Logo</label>
                    {{ form.logo_type }}
                    {% for error in form.logo_type.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>

                  <h5 class="text-bold text-primary text-center pt-3 m-0">Dimensiones y Medidas (mm)</h5>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.plant_reel_width.id_for_label }}" class="form-label" style="position: relative;">Ancho Bobina Planta</label>
                    {{ form.plant_reel_width }}
                    {% for error in form.plant_reel_width.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.client_reel_width.id_for_label }}" class="form-label" style="position: relative;">Ancho Bobina Cliente</label>
                    {{ form.client_reel_width }}
                    {% for error in form.client_reel_width.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.packaging_unit_width.id_for_label }}" class="form-label" style="position: relative;">Ancho Unidad Empaque</label>
                    {{ form.packaging_unit_width }}
                    {% for error in form.packaging_unit_width.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.packaging_unit_length.id_for_label }}" class="form-label" style="position: relative;">Largo Unidad Empaque</label>
                    {{ form.packaging_unit_length }}
                    {% for error in form.packaging_unit_length.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="{{ form.tolerance.id_for_label }}" class="form-label" style="position: relative;">Tolerancia</label>
                    {{ form.tolerance }}
                    {% for error in form.tolerance.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>

                  <h5 class="text-bold text-primary text-center pt-3 m-0">Especificaciones de Fotocelda</h5>
                  <div class="col-12 mb-3">
                    <div class="form-check">
                      {{ form.has_photocell }}
                      <label class="form-check-label" for="{{ form.has_photocell.id_for_label }}">Lleva Fotocelda</label>
                    </div>
                  </div>
                  <div id="photocell-fields" style="display: {% if form.has_photocell.value %}flex{% else %}none{% endif %};" class="row w-100 mx-0">
                      <div class="col-md-3 mb-3">
                        <label for="{{ form.photocell_width.id_for_label }}" class="form-label" style="position: relative;">Ancho Fotocelda (mm)</label>
                        {{ form.photocell_width }}
                        {% for error in form.photocell_width.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </div>
                      <div class="col-md-3 mb-3">
                        <label for="{{ form.photocell_length.id_for_label }}" class="form-label" style="position: relative;">Largo Fotocelda (mm)</label>
                        {{ form.photocell_length }}
                        {% for error in form.photocell_length.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </div>
                      <div class="col-md-3 mb-3">
                        <label for="{{ form.photocell_distance.id_for_label }}" class="form-label" style="position: relative;">Distancia (mm)</label>
                        {{ form.photocell_distance }}
                        {% for error in form.photocell_distance.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </div>
                      <div class="col-md-3 mb-3">
                        <label for="{{ form.photocell_colors.id_for_label }}" class="form-label" style="position: relative;">Colores Fotocelda</label>
                        {{ form.photocell_colors }}
                        {% for error in form.photocell_colors.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </div>
                  </div>
                  <h5 class="text-bold text-primary text-center pt-3 m-0">Observaciones</h5>
                  <div class="col-12 mb-3 {% if form.observations.errors %}quill-error-outline{% endif %}">
                    {{ form.observations }}
                     {% for error in form.observations.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                  </div>
                  
                  <div class="d-flex flex-wrap justify-content-center col-12 pt-md-2 px-0">
                    <div class="col-md-6 mb-3">
                      <label for="{{ form.elaborator.id_for_label }}" class="form-label" style="position: relative;">Realizado por</label>
                      {{ form.elaborator }}
                      {% for error in form.elaborator.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="{{ form.reviewer.id_for_label }}" class="form-label" style="position: relative;">Revisado por</label>
                      {{ form.reviewer }}
                      {% for error in form.reviewer.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-center col-12 p-0 mt-3">
                  <button type="submit" class="btn mx-1 mb-0 btn-primary">Guardar</button>
                  <button type="submit" class="btn mx-1 mb-0 btn-info" id="save_and_view">Guardar y Ver</button>
                  <button type="button" class="btn mx-1 mb-0 btn-secondary" data-bs-toggle="modal" data-bs-target="#cancelModal">Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true" style="user-select: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold" id="cancelModalLabel">Confirmación de Cancelación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que quieres cancelar? Los cambios no guardados se perderán.
      </div>
      <div class="modal-footer">
        <button type="button" class="mb-1 btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" class="mb-1 btn btn-primary" onClick="window.history.back();">Sí, cancelar</button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
  $(document).ready(function() {
    // Add Bootstrap classes to form elements
    $('#main-form').find('input:not([type=checkbox]), textarea, select').addClass('form-control');
    $('#main-form').find('input[type=checkbox]').addClass('form-check-input');

    // Add is-invalid class to fields with errors
    {% for field in form %}
        {% if field.errors %}
            $('#{{ field.id_for_label }}').addClass('is-invalid');
        {% endif %}
    {% endfor %}

    // Save and view button
    $('#save_and_view').click(function() {
      $('<input />').attr('type', 'hidden').attr('name', 'save_and_view').attr('value', 'True').appendTo('#main-form');
    });

    // Disable submit buttons on form submission
    $('#main-form').on('submit', function() {
      $(this).find('button[type="submit"]').prop('disabled', true);
    });

    // Show/hide photocell fields based on checkbox
    $('#id_has_photocell').change(function() {
      $('#photocell-fields').css('display', this.checked ? 'flex' : 'none');
    });

    // Datepicker
    $( "#id_date" ).datepicker({ showOtherMonths: true, selectOtherMonths: true, ...$.datepicker.regional[ "es" ] });

    // Select2
      $('#id_client, #id_printer').select2({
    placeholder: 'Seleccione...',
    width: '100%',
    allowClear: true,
    selectionCssClass: 'form-control', 
    dropdownCssClass: 'form-control'   
  });

  $('#id_company').select2({
    minimumResultsForSearch: Infinity,
    allowClear: true,
    placeholder: 'Empresa...',
    width: '100%',
    selectionCssClass: 'form-control', 
    dropdownCssClass: 'form-control'
  });
  });
// --- Lógica para el formset de art_colors ---
  function updateColorFormIndices() {
    let forms = $('#color_form_set tr');
    forms.each(function(i, row) {
      $(row).attr('id', 'color-row-' + i);
      $(row).find(':input, label').each(function() {
        if ($(this).attr('name')) {
          $(this).attr('name', $(this).attr('name').replace(/-\d+-/, '-' + i + '-'));
        }
        if ($(this).attr('id')) {
          $(this).attr('id', $(this).attr('id').replace(/-\d+-/, '-' + i + '-'));
        }
        if ($(this).attr('for')) {
          $(this).attr('for', $(this).attr('for').replace(/-\d+-/, '-' + i + '-'));
        }
      });
    });
  }

  $('#add_color_row').click(function () {
    let totalForms = parseInt($('#id_colors-TOTAL_FORMS').val());
    let newFormHtml = $('#empty_color_form').html().replace(/__prefix__/g, totalForms);
    $('#color_form_set').append(newFormHtml);
    $('#id_colors-TOTAL_FORMS').val(totalForms + 1);
    updateColorFormIndices();
  });

  $('#remove_color_row').click(function () {
    let forms = $('#color_form_set tr');
    if (forms.length > 1) {
      forms.last().remove();
      $('#id_colors-TOTAL_FORMS').val(forms.length - 1);
      updateColorFormIndices();
    }
  });
// --- Fin lógica formset art_colors ---
</script>
{% endblock javascripts %}
